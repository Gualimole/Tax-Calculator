<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Recipe 3: Creating a Custom Table &ndash; Documentation</title>

		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="">
		<meta name="keywords" content="">
		<meta name="description" content="">

		<link rel="stylesheet" href="/_static/css/base.css">

	</head>

	<body>

		<div class="wrapper">

			<header class="header">

				<div class="branding">

					<p class="site-title"><a href="/">Documentation</a></p>

					<p class="sr-only"><a href="#skip">Skip to content</a></p>

				</div>

				<div class="header-tools">


					<div class="header-badge" id="executability_status_badge"></div>


				</div>

			</header>

			<div class="main">

				<div class="content">

					<div id="skip"></div>

					<div class="document">

<div class="{} cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Recipe-3:-Creating-a-Custom-Table">Recipe 3: Creating a Custom Table<a class="anchor-link" href="#Recipe-3:-Creating-a-Custom-Table">&#182;</a></h1><p>This is an advanced recipe that should be followed only after mastering the basic recipe.
This recipe shows how to prepare a custom table.</p>

</div>
</div>
</div>

<div class="{} cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
	<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">taxcalc</span> <span class="k">as</span> <span class="nn">tc</span>

<span class="c1"># use publicly-available CPS input file</span>
<span class="n">recs</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Records</span><span class="o">.</span><span class="n">cps_constructor</span><span class="p">()</span>

<span class="c1"># specify Calculator object for static analysis of current-law policy</span>
<span class="n">pol</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Policy</span><span class="p">()</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Calculator</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">recs</span><span class="p">)</span>

<span class="n">CYR</span> <span class="o">=</span> <span class="mi">2020</span>

<span class="c1"># calculate aggregate current-law income tax liabilities for cyr</span>
<span class="n">calc</span><span class="o">.</span><span class="n">advance_to_year</span><span class="p">(</span><span class="n">CYR</span><span class="p">)</span>
<span class="n">calc</span><span class="o">.</span><span class="n">calc_all</span><span class="p">()</span>

<span class="c1"># tabulate custom table showing number of filing units receiving EITC</span>
<span class="c1"># and the average positive EITC amount by IRS-SOI AGI categories</span>
<span class="n">vardf</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">dataframe</span><span class="p">([</span><span class="s1">&#39;s006&#39;</span><span class="p">,</span> <span class="s1">&#39;c00100&#39;</span><span class="p">,</span> <span class="s1">&#39;eitc&#39;</span><span class="p">])</span>
<span class="n">vardf</span> <span class="o">=</span> <span class="n">add_income_table_row_variable</span><span class="p">(</span><span class="n">vardf</span><span class="p">,</span> <span class="s1">&#39;c00100&#39;</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">SOI_AGI_BINS</span><span class="p">)</span>
<span class="n">gbydf</span> <span class="o">=</span> <span class="n">vardf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;table_row&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

	</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

	<div class="prompt"></div>


<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-88c06f43a0a7&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     17</span> <span class="ansi-red-fg"># and the average positive EITC amount by IRS-SOI AGI categories</span>
<span class="ansi-green-intense-fg ansi-bold">     18</span> vardf <span class="ansi-blue-fg">=</span> calc<span class="ansi-blue-fg">.</span>dataframe<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;s006&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;c00100&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;eitc&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 19</span><span class="ansi-red-fg"> </span>vardf <span class="ansi-blue-fg">=</span> add_income_table_row_variable<span class="ansi-blue-fg">(</span>vardf<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;c00100&#39;</span><span class="ansi-blue-fg">,</span> tc<span class="ansi-blue-fg">.</span>SOI_AGI_BINS<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     20</span> gbydf <span class="ansi-blue-fg">=</span> vardf<span class="ansi-blue-fg">.</span>groupby<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;table_row&#39;</span><span class="ansi-blue-fg">,</span> as_index<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;add_income_table_row_variable&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>

<div class="{} cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Filing Units Receiving EITC and Average Positive EITC by AGI Category</p>

</div>
</div>
</div>

<div class="{} cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
	<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># print AGI table with ALL row at bottom</span>
<span class="n">results</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:23s}</span><span class="se">\t</span><span class="si">{:8.3f}</span><span class="se">\t</span><span class="si">{:8.3f}</span><span class="s1">&#39;</span>
<span class="n">colhead</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:23s}</span><span class="se">\t</span><span class="si">{:&gt;8s}</span><span class="se">\t</span><span class="si">{:&gt;8s}</span><span class="s1">&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">colhead</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;AGI Category&#39;</span><span class="p">,</span> <span class="s1">&#39;Num(#M)&#39;</span><span class="p">,</span> <span class="s1">&#39;Avg($K)&#39;</span><span class="p">))</span>
<span class="n">tot_recips</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">tot_amount</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">grp_interval</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">gbydf</span><span class="p">:</span>
    <span class="n">recips</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="n">grp</span><span class="p">[</span><span class="s1">&#39;eitc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s1">&#39;s006&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-6</span>
    <span class="n">tot_recips</span> <span class="o">+=</span> <span class="n">recips</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="p">(</span><span class="n">grp</span><span class="p">[</span><span class="s1">&#39;eitc&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">grp</span><span class="p">[</span><span class="s1">&#39;s006&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-9</span>
    <span class="n">tot_amount</span> <span class="o">+=</span> <span class="n">amount</span>
    <span class="k">if</span> <span class="n">recips</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">/</span> <span class="n">recips</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">glabel</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">{:.8g}</span><span class="s1">, </span><span class="si">{:.8g}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grp_interval</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">grp_interval</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">glabel</span><span class="p">,</span> <span class="n">recips</span><span class="p">,</span> <span class="n">avg</span><span class="p">))</span>
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">avg</span> <span class="o">=</span> <span class="n">tot_amount</span> <span class="o">/</span> <span class="n">tot_recips</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="n">tot_recips</span><span class="p">,</span> <span class="n">avg</span><span class="p">))</span>
</pre></div>

	</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

	<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>AGI Category           	 Num(#M)	 Avg($K)
</pre>
</div>
</div>

<div class="output_area">

	<div class="prompt"></div>


<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-2-8ec1b0186c9e&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span> tot_amount <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0.</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> idx <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
<span class="ansi-green-fg">----&gt; 8</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">for</span> grp_interval<span class="ansi-blue-fg">,</span> grp <span class="ansi-green-fg">in</span> gbydf<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      9</span>     recips <span class="ansi-blue-fg">=</span> grp<span class="ansi-blue-fg">[</span>grp<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;eitc&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">&gt;</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;s006&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>sum<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">*</span> <span class="ansi-cyan-fg">1e-6</span>
<span class="ansi-green-intense-fg ansi-bold">     10</span>     tot_recips <span class="ansi-blue-fg">+=</span> recips

<span class="ansi-red-fg">NameError</span>: name &#39;gbydf&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
 




					</div>

				</div>

			</div>

			<footer class="footer">

				<p>&copy; Copyright <YEAR>, Built using the minimal jupinx template.</p>

			</footer>

		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script src="/_static/js/base.js"></script>

	</body>
</html>