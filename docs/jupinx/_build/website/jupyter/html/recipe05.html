<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Recipe 5: Redefining Expanded Income &ndash; Documentation</title>

		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="">
		<meta name="keywords" content="">
		<meta name="description" content="">

		<link rel="stylesheet" href="/_static/css/base.css">

	</head>

	<body>

		<div class="wrapper">

			<header class="header">

				<div class="branding">

					<p class="site-title"><a href="/">Documentation</a></p>

					<p class="sr-only"><a href="#skip">Skip to content</a></p>

				</div>

				<div class="header-tools">


					<div class="header-badge" id="executability_status_badge"></div>


				</div>

			</header>

			<div class="main">

				<div class="content">

					<div id="skip"></div>

					<div class="document">

<div class="{} cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Recipe-5:-Redefining-Expanded-Income">Recipe 5: Redefining Expanded Income<a class="anchor-link" href="#Recipe-5:-Redefining-Expanded-Income">&#182;</a></h1><p>This is an advanced recipe that should be followed only after mastering the basic recipe.
This recipe is almost exactly the same as Directly Comparing Two Reforms, so you might want to read that recipe first.</p>
<p>This recipe introduces a powerful technique for customizing the operation of Tax-Calculator.
This calculator-customization technique is used in this recipe to redefine expanded income in a way that allows the
redefined income measure to be used seamlessly with all the other (table and graph) methods of the Calculator class.
The basic idea behind the calculator-customization technique is to derive a customized Calculator class from the Tax-Calculator Calculator class.
This is a standard <a href="[https://pslmodels.github.io/Tax-Calculator/tc_overview.html](https://pslmodels.github.io/Tax-Calculator/tc_overview.html">object-oriented programming</a>) technique.</p>
<p>Recipe that illustrates how to customize the taxcalc Calculator class so that
it can seamlessly use an alternative definition of expanded income.</p>
<p>The technique for doing this customization is standard in object-oriented
programming: a child class is derived from a parent class and then customized.
The derived child class inherits all the data and methods of the parent class,
but can be customized by adding new data and methods or by overriding inherited
methods.</p>

</div>
</div>
</div>

<div class="{} cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
	<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">taxcalc</span> <span class="k">as</span> <span class="nn">tc</span>


<span class="c1"># override the ExpandIncome calcfunction that computes &quot;market income&quot;</span>


<span class="nd">@tc</span><span class="o">.</span><span class="n">iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ExpandIncome</span><span class="p">(</span><span class="n">e00200</span><span class="p">,</span> <span class="n">pencon_p</span><span class="p">,</span> <span class="n">pencon_s</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span>
                 <span class="n">e00700</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span> <span class="n">e01400</span><span class="p">,</span> <span class="n">e01500</span><span class="p">,</span>
                 <span class="n">e02000</span><span class="p">,</span> <span class="n">e02100</span><span class="p">,</span> <span class="n">p22250</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">cmbtp</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span>
                 <span class="n">expanded_income</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates expanded_income as &quot;market income&quot; from component income types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expanded_income</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">e00200</span> <span class="o">+</span>  <span class="c1"># wage and salary income net of DC pension contributions</span>
        <span class="n">pencon_p</span> <span class="o">+</span>  <span class="c1"># tax-advantaged DC pension contributions for taxpayer</span>
        <span class="n">pencon_s</span> <span class="o">+</span>  <span class="c1"># tax-advantaged DC pension contributions for spouse</span>
        <span class="n">e00300</span> <span class="o">+</span>  <span class="c1"># taxable interest income</span>
        <span class="n">e00400</span> <span class="o">+</span>  <span class="c1"># non-taxable interest income</span>
        <span class="n">e00600</span> <span class="o">+</span>  <span class="c1"># dividends</span>
        <span class="n">e00700</span> <span class="o">+</span>  <span class="c1"># state and local income tax refunds</span>
        <span class="n">e00800</span> <span class="o">+</span>  <span class="c1"># alimony received</span>
        <span class="n">e00900</span> <span class="o">+</span>  <span class="c1"># Sch C business net income/loss</span>
        <span class="n">e01100</span> <span class="o">+</span>  <span class="c1"># capital gain distributions not reported on Sch D</span>
        <span class="n">e01200</span> <span class="o">+</span>  <span class="c1"># Form 4797 other net gain/loss</span>
        <span class="n">e01400</span> <span class="o">+</span>  <span class="c1"># taxable IRA distributions</span>
        <span class="n">e01500</span> <span class="o">+</span>  <span class="c1"># total pension &amp; annuity income (including DB-plan benefits)</span>
        <span class="n">e02000</span> <span class="o">+</span>  <span class="c1"># Sch E total rental, ..., partnership, S-corp income/loss</span>
        <span class="n">e02100</span> <span class="o">+</span>  <span class="c1"># Sch F farm net income/loss</span>
        <span class="n">p22250</span> <span class="o">+</span>  <span class="c1"># Sch D: net short-term capital gain/loss</span>
        <span class="n">p23250</span> <span class="o">+</span>  <span class="c1"># Sch D: net long-term capital gain/loss</span>
        <span class="n">cmbtp</span> <span class="o">+</span>  <span class="c1"># other AMT taxable income items from Form 6251</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span>  <span class="c1"># employer share of FICA taxes on wages/salaries</span>
        <span class="c1"># excluding:</span>
        <span class="c1"># ubi +  # total UBI benefit</span>
        <span class="c1"># benefit_value_total  # consumption value of all benefits received;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">expanded_income</span>

<span class="c1"># end overrided calcfunction used by customized Calculator class</span>


<span class="k">class</span> <span class="nc">Calculator</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">Calculator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Customized Calculator class that inherits all tc.Calculator data and</span>
<span class="sd">    methods, overriding one method to get the desired customization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">sync_years</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">consumption</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># use same class constructor arguments as tc.Calculator class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">records</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">sync_years</span><span class="o">=</span><span class="n">sync_years</span><span class="p">,</span>
                         <span class="n">consumption</span><span class="o">=</span><span class="n">consumption</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calc_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zero_out_calc_vars</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call all tax-calculation functions for the current_year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tc</span><span class="o">.</span><span class="n">BenefitPrograms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_one_year</span><span class="p">(</span><span class="n">zero_out_calc_vars</span><span class="p">)</span>
        <span class="n">tc</span><span class="o">.</span><span class="n">BenefitSurtax</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tc</span><span class="o">.</span><span class="n">BenefitLimitation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tc</span><span class="o">.</span><span class="n">FairShareTax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__records</span><span class="p">)</span>
        <span class="n">tc</span><span class="o">.</span><span class="n">LumpSumTax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__records</span><span class="p">)</span>
        <span class="n">ExpandIncome</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__records</span><span class="p">)</span>  <span class="c1"># customized (see above)</span>
        <span class="n">tc</span><span class="o">.</span><span class="n">AfterTaxIncome</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__records</span><span class="p">)</span>

<span class="c1"># end of customized Calculator class definition</span>


<span class="c1"># top-level logic of program that uses customized Calculator class</span>

<span class="c1"># read an &quot;old&quot; reform file from Tax-Calculator website</span>
<span class="c1"># (&quot;old&quot; means the reform file is defined relative to pre-TCJA policy)</span>
<span class="n">reforms_url</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/&#39;</span>
               <span class="s1">&#39;PSLmodels/Tax-Calculator/master/taxcalc/reforms/&#39;</span><span class="p">)</span>

<span class="c1"># specify reform dictionary for pre-TCJA policy</span>
<span class="n">reform1</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">read_json_reform</span><span class="p">(</span><span class="n">reforms_url</span> <span class="o">+</span> <span class="s1">&#39;2017_law.json&#39;</span><span class="p">)</span>

<span class="c1"># specify reform dictionary for TCJA as passed by Congress in late 2017</span>
<span class="n">reform2</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">read_json_reform</span><span class="p">(</span><span class="n">reforms_url</span> <span class="o">+</span> <span class="s1">&#39;TCJA.json&#39;</span><span class="p">)</span>

<span class="c1"># specify Policy object for pre-TCJA policy</span>
<span class="n">bpolicy</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Policy</span><span class="p">()</span>
<span class="n">bpolicy</span><span class="o">.</span><span class="n">implement_reform</span><span class="p">(</span><span class="n">reform1</span><span class="p">,</span> <span class="n">print_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">bpolicy</span><span class="o">.</span><span class="n">parameter_errors</span>

<span class="c1"># specify Policy object for TCJA reform relative to pre-TCJA policy</span>
<span class="n">rpolicy</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Policy</span><span class="p">()</span>
<span class="n">rpolicy</span><span class="o">.</span><span class="n">implement_reform</span><span class="p">(</span><span class="n">reform1</span><span class="p">,</span> <span class="n">print_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">rpolicy</span><span class="o">.</span><span class="n">parameter_errors</span>
<span class="n">rpolicy</span><span class="o">.</span><span class="n">implement_reform</span><span class="p">(</span><span class="n">reform2</span><span class="p">,</span> <span class="n">print_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">rpolicy</span><span class="o">.</span><span class="n">parameter_errors</span>

<span class="c1"># specify customized Calculator objects using bpolicy and rpolicy</span>
<span class="n">recs</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">Records</span><span class="o">.</span><span class="n">cps_constructor</span><span class="p">()</span>
<span class="n">calc1</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">bpolicy</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">recs</span><span class="p">)</span>
<span class="n">calc2</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">rpolicy</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">recs</span><span class="p">)</span>

<span class="n">CYR</span> <span class="o">=</span> <span class="mi">2018</span>

<span class="c1"># calculate for specified CYR</span>
<span class="n">calc1</span><span class="o">.</span><span class="n">advance_to_year</span><span class="p">(</span><span class="n">CYR</span><span class="p">)</span>
<span class="n">calc1</span><span class="o">.</span><span class="n">calc_all</span><span class="p">()</span>
<span class="n">calc2</span><span class="o">.</span><span class="n">advance_to_year</span><span class="p">(</span><span class="n">CYR</span><span class="p">)</span>
<span class="n">calc2</span><span class="o">.</span><span class="n">calc_all</span><span class="p">()</span>

<span class="c1"># compare aggregate individual income tax revenue in CYR</span>
<span class="n">iitax_rev1</span> <span class="o">=</span> <span class="n">calc1</span><span class="o">.</span><span class="n">weighted_total</span><span class="p">(</span><span class="s1">&#39;iitax&#39;</span><span class="p">)</span>
<span class="n">iitax_rev2</span> <span class="o">=</span> <span class="n">calc2</span><span class="o">.</span><span class="n">weighted_total</span><span class="p">(</span><span class="s1">&#39;iitax&#39;</span><span class="p">)</span>

<span class="c1"># construct reform-vs-baseline difference table with results for income deciles</span>
<span class="n">diff_table</span> <span class="o">=</span> <span class="n">calc1</span><span class="o">.</span><span class="n">difference_table</span><span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="s1">&#39;weighted_deciles&#39;</span><span class="p">,</span> <span class="s1">&#39;iitax&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diff_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="n">diff_extract</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">dif_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;tax_cut&#39;</span><span class="p">,</span> <span class="s1">&#39;tax_inc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tot_change&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;pc_aftertaxinc&#39;</span><span class="p">]</span>
<span class="n">ext_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;funits(#m)&#39;</span><span class="p">,</span> <span class="s1">&#39;taxfall(#m)&#39;</span><span class="p">,</span> <span class="s1">&#39;taxrise(#m)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;agg_diff($b)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_diff($)&#39;</span><span class="p">,</span> <span class="s1">&#39;aftertax_income_diff(%)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">ename</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dif_colnames</span><span class="p">,</span> <span class="n">ext_colnames</span><span class="p">):</span>
    <span class="n">diff_extract</span><span class="p">[</span><span class="n">ename</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_table</span><span class="p">[</span><span class="n">dname</span><span class="p">]</span>

<span class="c1"># print total revenue estimates for CYR</span>
<span class="c1"># (estimates in billons of dollars)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_REFORM1_iitax_rev($B)= </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CYR</span><span class="p">,</span> <span class="n">iitax_rev1</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_REFORM2_iitax_rev($B)= </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CYR</span><span class="p">,</span> <span class="n">iitax_rev2</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># print reform2-vs-reform1 difference table</span>
<span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Extract of </span><span class="si">{}</span><span class="s1"> income-tax difference table by expanded-income decile&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CYR</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(taxfall is count of funits with cut in income tax in reform 2 vs 1)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(taxrise is count of funits with rise in income tax in reform 2 vs 1)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diff_extract</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>

	</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

	<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>2018_REFORM1_iitax_rev($B)= 1422.968
2018_REFORM2_iitax_rev($B)= 1272.649

Extract of 2018 income-tax difference table by expanded-income decile
(taxfall is count of funits with cut in income tax in reform 2 vs 1)
(taxrise is count of funits with rise in income tax in reform 2 vs 1)
        funits(#m)  taxfall(#m)  taxrise(#m)  agg_diff($b)  mean_diff($)  aftertax_income_diff(%)
0-10n         0.07         0.00         0.00         0.006          94.0                      0.0
0-10z        15.87         0.00         0.01        -0.000          -0.0                    -10.1
0-10p         0.34         0.00         0.00         0.000           0.0                      0.0
10-20        16.29         1.08         0.68        -0.075          -4.6                      0.1
20-30        16.29         9.95         2.66        -1.531         -94.0                      0.6
30-40        16.29        12.77         2.12        -3.741        -229.7                      1.0
40-50        16.29        13.55         2.17        -7.217        -443.1                      1.5
50-60        16.29        13.78         2.22       -10.153        -623.4                      1.6
60-70        16.28        13.64         2.45       -12.430        -763.3                      1.5
70-80        16.29        14.00         2.13       -16.511       -1013.7                      1.5
80-90        16.29        13.84         2.35       -23.084       -1417.4                      1.4
90-100       16.29        14.54         1.71       -75.584       -4640.8                      2.1
ALL         162.86       107.16        18.49      -150.319        -923.0                      1.7
90-95         8.14         7.15         0.96       -18.297       -2246.9                      1.6
95-99         6.51         5.97         0.54       -34.982       -5369.6                      2.5
Top 1%        1.63         1.42         0.20       -22.305      -13695.2                      2.1
</pre>
</div>
</div>

</div>
</div>

</div>
 




					</div>

				</div>

			</div>

			<footer class="footer">

				<p>&copy; Copyright <YEAR>, Built using the minimal jupinx template.</p>

			</footer>

		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script src="/_static/js/base.js"></script>

	</body>
</html>